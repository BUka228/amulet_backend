# Тесты для Amulet Backend

## Обзор

Комплексная система тестирования для третьего шага плана реализации - "База данных (Firestore)". Включает юнит-тесты, интеграционные тесты с Firebase Emulator Suite, тесты для скриптов сидов и проверку индексов.

## Структура тестов

### 1. Юнит-тесты (`firestore.unit.test.ts`)
- Тестирование всех типов и интерфейсов Firestore
- Валидация структуры данных
- Проверка типов и значений
- Тестирование различных сценариев использования

### 2. Интеграционные тесты (`firestore.integration.test.ts`)
- Тестирование с реальной базой данных через Emulator Suite
- Проверка правил безопасности Firestore
- Тестирование CRUD операций
- Проверка сложных запросов и пагинации

### 3. Тесты скриптов сидов (`seed.test.ts`)
- Тестирование создания начального контента
- Проверка структуры создаваемых данных
- Валидация локализации и метаданных
- Тестирование множественных запусков

### 4. Тесты индексов (`firestore.indexes.test.ts`)
- Проверка всех составных индексов
- Тестирование запросов с array-contains
- Проверка производительности запросов
- Тестирование пагинации и сортировки

## Запуск тестов

### Предварительные требования
```bash
# Установка зависимостей
npm install

# Установка Firebase CLI (если не установлен)
npm install -g firebase-tools

# Инициализация Firebase (если не сделано)
firebase login
firebase init
```

### Команды для запуска

#### Все тесты
```bash
npm test
```

#### Отдельные категории тестов
```bash
# Юнит-тесты
npm run test:unit

# Интеграционные тесты
npm run test:integration

# Тесты Firestore
npm run test:firestore

# Тесты скриптов сидов
npm run test:seed

# Тесты индексов
npm run test:indexes
```

#### Тесты с покрытием
```bash
npm run test:coverage
```

#### Тесты в режиме наблюдения
```bash
npm run test:watch
```

#### Тесты с эмуляторами
```bash
# Запуск эмуляторов
npm run emulators

# Тесты с эмуляторами
npm run emulators:test
```

## Конфигурация

### Jest конфигурация (`jest.config.js`)
- TypeScript поддержка
- Настройка для Firebase Emulator Suite
- Увеличенные таймауты для интеграционных тестов
- Ограничение воркеров для стабильности эмуляторов

### Глобальная настройка (`global-setup.ts`)
- Автоматический запуск Firebase Emulator Suite
- Настройка переменных окружения
- Ожидание готовности эмуляторов

### Глобальная очистка (`global-teardown.ts`)
- Остановка эмуляторов после тестов
- Очистка временных файлов
- Освобождение ресурсов

### Настройка тестов (`setup.ts`)
- Утилиты для создания тестовых данных
- Функции для проверки индексов
- Утилиты для тестирования производительности
- Функции для тестирования правил безопасности

## Тестовые данные

### Коллекции Firestore
- `users` - пользователи
- `devices` - устройства
- `pairs` - связи между пользователями
- `hugs` - объятия
- `practices` - практики
- `patterns` - паттерны анимаций
- `sessions` - сессии практик
- `telemetry` - телеметрия
- `firmware` - прошивки

### Тестовые сценарии
1. **CRUD операции** - создание, чтение, обновление, удаление
2. **Правила безопасности** - проверка доступа к данным
3. **Сложные запросы** - составные индексы, фильтрация, сортировка
4. **Пагинация** - cursor-based пагинация
5. **Производительность** - время выполнения запросов
6. **Валидация данных** - проверка типов и структуры

## Покрытие тестами

### Цели покрытия
- **Юнит-тесты**: 100% покрытие типов и интерфейсов
- **Интеграционные тесты**: 90% покрытие CRUD операций
- **Тесты индексов**: 100% покрытие всех индексов
- **Тесты сидов**: 100% покрытие скриптов создания данных

### Метрики качества
- Все тесты должны проходить
- Время выполнения < 30 секунд
- Покрытие кода > 80%
- Нет утечек памяти в эмуляторах

## Отладка тестов

### Логирование
```bash
# Подробные логи
DEBUG=* npm test

# Логи только Firebase
DEBUG=firebase:* npm test
```

### Отладка эмуляторов
```bash
# Запуск эмуляторов в отдельном терминале
firebase emulators:start --only firestore,auth,storage,functions

# Проверка статуса
curl http://localhost:8080
```

### Проблемы и решения

#### Эмуляторы не запускаются
```bash
# Очистка портов
lsof -ti:8080 | xargs kill -9
lsof -ti:9099 | xargs kill -9
lsof -ti:9199 | xargs kill -9
lsof -ti:5001 | xargs kill -9
```

#### Таймауты тестов
- Увеличьте `testTimeout` в `jest.config.js`
- Проверьте производительность системы
- Убедитесь, что эмуляторы запущены

#### Ошибки типов
```bash
# Пересборка TypeScript
npm run build

# Проверка типов
npx tsc --noEmit
```

## CI/CD интеграция

### GitHub Actions
```yaml
- name: Run tests with emulators
  run: |
    npm install
    npm run emulators:test
```

### Локальная разработка
```bash
# Быстрый цикл разработки
npm run test:watch

# Проверка перед коммитом
npm run test:all
npm run lint
npm run build
```

## Мониторинг

### Метрики тестов
- Время выполнения
- Количество тестов
- Покрытие кода
- Успешность прохождения

### Алерты
- Падение тестов
- Увеличение времени выполнения
- Снижение покрытия
- Ошибки эмуляторов

## Расширение тестов

### Добавление новых тестов
1. Создайте файл `*.test.ts` в `src/tests/`
2. Импортируйте необходимые утилиты из `setup.ts`
3. Используйте `testEnv` для работы с эмуляторами
4. Добавьте тест в соответствующую категорию

### Добавление новых утилит
1. Расширьте `setup.ts` новыми функциями
2. Экспортируйте типы для TypeScript
3. Добавьте документацию
4. Создайте тесты для утилит

## Лучшие практики

### Структура тестов
- Один тест = одна проверка
- Четкие названия тестов
- Группировка по функциональности
- Использование `describe` и `it`

### Данные для тестов
- Изолированные тестовые данные
- Очистка после каждого теста
- Предсказуемые значения
- Минимально необходимые данные

### Производительность
- Параллельное выполнение где возможно
- Кэширование общих данных
- Оптимизация запросов
- Мониторинг времени выполнения


