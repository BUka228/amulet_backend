# Настройка асинхронного удаления пользователей

## Обзор

Система асинхронного удаления пользователей использует Google Cloud Pub/Sub для обработки запросов на удаление в фоновом режиме. Это обеспечивает быстрый ответ клиенту и надежную обработку данных.

## Архитектура

1. **POST /v1/users.me/delete** - создает задачу удаления и публикует сообщение в Pub/Sub
2. **processUserDeletion** - Cloud Function, обрабатывающая сообщения из топика
3. **deletionJobs** - коллекция Firestore для отслеживания статуса задач

## Настройка Pub/Sub

### 1. Создание топика

```bash
# Создать топик для удаления пользователей
gcloud pubsub topics create user-deletion

# Создать подписку (опционально, для мониторинга)
gcloud pubsub subscriptions create user-deletion-sub --topic=user-deletion
```

### 2. Настройка прав доступа

```bash
# Дать права Cloud Functions на публикацию в топик
gcloud pubsub topics add-iam-policy-binding user-deletion \
    --member="serviceAccount:PROJECT_ID@appspot.gserviceaccount.com" \
    --role="roles/pubsub.publisher"

# Дать права Cloud Functions на получение сообщений
gcloud pubsub subscriptions add-iam-policy-binding user-deletion-sub \
    --member="serviceAccount:PROJECT_ID@appspot.gserviceaccount.com" \
    --role="roles/pubsub.subscriber"
```

## Переменные окружения (без functions.config())

Начиная с 2026, `functions.config()` депрекейтится. Используем dotenv файлы:

1. Создайте файл `functions/.env` (или используйте `functions/.env.example` как шаблон)
2. Добавьте переменные окружения:

```dotenv
# Стратегия удаления: 'anonymize' (по умолчанию) или 'delete'
USER_DELETION_STRATEGY=anonymize

# Дополнительно: конфиг Redis (по необходимости)
# REDIS_URL=redis://user:pass@host:6379
# REDIS_HOST=localhost
# REDIS_PORT=6379
# REDIS_TLS=false
# USE_INMEMORY=true
```

В коде значения читаются через `process.env.*`.

## Стратегии удаления

### 1. Анонимизация (по умолчанию)

- Заменяет PII данные на анонимные значения
- Сохраняет структуру данных для аналитики
- Устанавливает флаги `isDeleted: true`

### 2. Полное удаление

- Удаляет все документы пользователя
- Необратимая операция
- Используется только при необходимости

## Мониторинг

### 1. Логи Cloud Functions

```bash
# Просмотр логов функции удаления
firebase functions:log --only processUserDeletion

# Фильтрация по уровню ошибок
firebase functions:log --only processUserDeletion --filter="severity>=ERROR"
```

### 2. Метрики Pub/Sub

- Количество опубликованных сообщений
- Количество обработанных сообщений
- Время обработки
- Ошибки доставки

### 3. Firestore коллекция deletionJobs

```javascript
// Проверка статуса задачи
const job = await db.collection('deletionJobs').doc('del_1234567890_abc123').get();
console.log(job.data());
// {
//   jobId: 'del_1234567890_abc123',
//   userId: 'user_123',
//   status: 'completed',
//   createdAt: Timestamp,
//   completedAt: Timestamp
// }
```

## Обработка ошибок

### 1. Повторные попытки

Pub/Sub автоматически повторяет доставку сообщений при ошибках. Максимум 5 попыток.

### 2. Dead Letter Queue

Настройте DLQ для сообщений, которые не удалось обработать:

```bash
gcloud pubsub subscriptions create user-deletion-dlq \
    --topic=user-deletion \
    --dead-letter-topic=user-deletion-dlq
```

### 3. Алерты

Настройте алерты на:
- Высокий процент ошибок обработки
- Долгое время выполнения задач
- Накопление сообщений в очереди

## Тестирование

### 1. Локальное тестирование

```bash
# Запуск эмуляторов
firebase emulators:start --only functions,firestore,pubsub

# Тестирование через API
curl -X POST https://localhost:5001/PROJECT_ID/us-central1/api/v1/users.me/delete \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

### 2. Тестирование в продакшене

```bash
# Создание тестовой задачи
gcloud pubsub topics publish user-deletion \
    --message='{"jobId":"test_123","userId":"test_user","requestedAt":"2024-01-01T00:00:00Z","priority":"normal"}'
```

## Безопасность

### 1. Валидация данных

- Проверка существования пользователя
- Проверка прав доступа
- Валидация формата сообщения

### 2. Аудит

- Логирование всех операций удаления
- Сохранение метаданных задач
- Отслеживание изменений статуса

### 3. Ограничения

- Максимум 1 активная задача удаления на пользователя
- Таймаут на выполнение задачи (24 часа)
- Проверка прав доступа перед обработкой

## Восстановление данных

При использовании стратегии анонимизации данные можно частично восстановить:

```javascript
// Восстановление профиля пользователя
await db.collection('users').doc(userId).update({
  isDeleted: false,
  displayName: 'Restored User',
  email: 'user@example.com',
  restoredAt: FieldValue.serverTimestamp()
});
```

## Производительность

### 1. Масштабирование

- Cloud Functions автоматически масштабируются
- Параллельная обработка задач
- Ограничение на количество одновременных задач

### 2. Оптимизация

- Batch операции в Firestore
- Асинхронная обработка
- Кэширование часто используемых данных

## Troubleshooting

### Частые проблемы

1. **Задача не обрабатывается**
   - Проверить права доступа к Pub/Sub
   - Проверить логи Cloud Functions
   - Проверить статус топика

2. **Ошибки Firestore**
   - Проверить права доступа к Firestore
   - Проверить лимиты запросов
   - Проверить индексы

3. **Долгое выполнение**
   - Проверить размер данных пользователя
   - Оптимизировать batch операции
   - Увеличить timeout функции

### Полезные команды

```bash
# Проверка статуса топика
gcloud pubsub topics describe user-deletion

# Просмотр подписок
gcloud pubsub subscriptions list --filter="topic:user-deletion"

# Очистка старых задач
firebase firestore:delete --recursive deletionJobs --where="createdAt<2024-01-01"
```
