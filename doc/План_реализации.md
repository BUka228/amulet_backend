## План реализации Amulet Backend (Firebase)

Документ — пошаговый чек‑лист по запуску и сопровождению бэкенда. Для каждого шага указаны критерии завершённости (DoD). Отмечайте выполнение галочками.

### 0. Организация и репозиторий
- [ ] Создать репозиторий и структуру директорий (`functions/`, `public/`, `doc/`)
  - Критерии: репозиторий в VCS; шаблон `.gitignore`; базовая структура создана
- [ ] Настроить Node.js LTS и пакетный менеджер (pnpm/npm)
  - Критерии: `node -v` зафиксирован; lockfile присутствует; скрипты `lint`, `test`, `build` в `functions/package.json`
- [ ] Принять соглашения код‑стайла и линтеров (ESLint/Prettier/TSConfig)
  - Критерии: конфиги в корне; `pnpm lint`/`pnpm format` проходят без ошибок
- [ ] Настроить управление зависимостями (Dependabot/Renovate)
  - Критерии: PR‑бот создаёт обновления; CI прогоняется на PR; авто‑мердж патчей безопасности включён

### 1. Firebase проекты и среды
- [ ] Создать проекты: `amulet-dev`, `amulet-staging`, `amulet-prod`
  - Критерии: проекты видны в консоли; роли доступа назначены
- [ ] Включить сервисы: Auth, Firestore, Storage, App Check, Cloud Functions, Cloud Messaging, Hosting, Remote Config
  - Критерии: все сервисы активны; квоты проверены

### 2. Аутентификация и App Check
- [ ] Настроить провайдеры Auth (Email/Password, Apple, Google)
  - Критерии: включены провайдеры; настроены OAuth redirect URLs
- [ ] Зарегистрировать приложения iOS/Android/Web, включить App Check
  - Критерии: App Check ключи выданы; SDK конфиг добавлен на фронт; проверки включены
- [ ] Реализовать middleware проверки ID Token и App Check в `functions/core/auth.ts`
  - Критерии: e2e тест на защищённую ручку возвращает 401/403 при нарушениях

### 3. База данных (Firestore)
- [ ] Создать коллекции: `users`, `devices`, `pairs`, `hugs`, `practices`, `patterns`, `rules`, `sessions`, `telemetry`, `firmware`
  - Критерии: описаны модели в `functions/types/*`
- [ ] Применить индексы из `doc/firestore.indexes.json.template`
  - Критерии: импорт индексов выполнен; статусы — `READY`
- [ ] Написать миграции сидов контента (минимальный набор практик/паттернов)
  - Критерии: скрипт сидов запускается локально/CI; данные созданы

### 4. Хранилище (Storage)
- [ ] Настроить пути: `avatars/{userId}/...`, `audio/practices/{practiceId}/...`, `firmware/{hardwareVersion}/{semver}/...`
  - Критерии: директории/права проверены правилами
- [ ] Загрузить тестовые файлы (1 аватар, 1 аудио, 1 прошивка‑заглушка)
  - Критерии: публичное чтение каталога/прошивки работает; приватность аватаров соблюдена

### 5. Security Rules
- [ ] Применить Firestore Rules из `doc/firestore.rules.template`
  - Критерии: положительные/негативные тесты через Emulator Suite (own vs foreign docs)
- [ ] Применить Storage Rules из `doc/storage.rules.template`
  - Критерии: загрузка аватара владельцем разрешена; другие операции корректно запрещены

### 6. HTTP API (/v1)
- [ ] Сборка Express‑роутера и общих middleware (`core/http.ts`): логирование, corr‑id, ETag, rate‑limit, idempotency
  - Критерии: все middleware активны; интеграционные тесты зелёные
- [ ] Пользователи: `POST /users.me.init`, `GET/PATCH /users.me`, `POST /users.me/delete`
  - Критерии: сценарий онбординга проходит; удаление — 202 + задача поставлена
- [ ] Устройства: `POST /devices.claim`, `GET /devices`, `GET/PATCH /devices/:id`, `POST /devices/:id/unclaim`
  - Критерии: привязка по `serial+claimToken` работает; защита владения активна
  - Критерии (доп.): протестирована передача устройства другому пользователю через `unclaim` → `claim`
- [ ] Объятия: `POST /hugs.send`, `GET /hugs`, `GET /hugs/:id`
  - Критерии: доставка пуша получателю; история фильтруется и пагинируется
- [ ] Пары: `POST /pairs.invite`, `POST /pairs.accept`, `GET /pairs`, `POST /pairs/:id/block`
  - Критерии: инвайт с TTL; блокировка предотвращает отправку объятий
- [ ] Контент и паттерны: каталог практик + `POST/GET/PATCH/DELETE /patterns`, `GET /patterns.mine`, `POST /patterns/:id/share`, `POST /patterns/preview`
  - Критерии: фильтры `hardwareVersion/kind/tags`; превью валидирует `spec`
- [ ] Сессии/статистика: `POST /practices/:id/start`, `POST /practices.session/:id/stop`, `GET /stats/overview`
  - Критерии: создание/закрытие сессий; рассчёт overview корректный
- [ ] Правила/IFTTT: `GET/POST/PATCH/DELETE /rules`, `POST /webhooks/:integrationKey`
  - Критерии: проверка подписи `X-Signature`; анти‑replay
- [ ] Уведомления: `POST/DELETE /notifications.tokens`
  - Критерии: токены сохраняются/удаляются; FCM отправка работает
- [ ] OTA: `GET /ota/firmware/latest`, `POST /devices/:id/firmware/report`
  - Критерии: выдаётся корректная версия; репорты агрегируются
- [ ] Телеметрия: `POST /telemetry/events` (батч)
  - Критерии: валидируются события; фоновые агрегации создают метрики

### 7. Идемпотентность и лимитирование
- [ ] Реализация `Idempotency-Key` в `core/idempotency.ts`
  - Критерии: повторный POST возвращает идентичный ответ из кэша в течение TTL
- [ ] Реализация rate‑limit в `core/rateLimit.ts`
  - Критерии: при превышении 429 + `Retry-After`; конфиги через Remote Config

### 8. Уведомления (FCM)
- [ ] Карта событий: `hug.received`, `pair.invite`, `practice.reminder`, `ota.available`
  - Критерии: шаблоны пушей и локализация готовы; доставляется на тестовые устройства

### 9. Админка и роли
- [ ] Custom claims (`admin`, `moderator`) и утилиты назначения
  - Критерии: ручки `/v1/admin/*` требуют `admin` и проходят
- [ ] Админ‑ручки: модерация контента/паттернов, публикация прошивок, поиск устройств
  - Критерии: сценарии модерации от начала до публикации работают; протестирован отзыв/бан устройства через админку

### 10. Мониторинг, логи, алерты
- [ ] Структурированное логирование (requestId, userId, route, latency)
  - Критерии: логи в Cloud Logging с фильтрами/дашбордами
- [ ] Трейсинг Cloud Trace + метрики Cloud Monitoring
  - Критерии: дашборды p50/p95, ошибки 4xx/5xx, алерты по SLO

### 11. Remote Config и флаги
- [ ] Ввести ключи: `api.deprecation.v1`, `hugs.cooldown.ms`, `preview.enabled` и пр.
  - Критерии: переключение фич без релиза; аудит изменений включён

### 12. Документация (OpenAPI + Swagger UI)
- [ ] Обновить `doc/openapi_v1.yaml` с ошибками 401/403/404/429 (выполнено)
  - Критерии: валидатор OpenAPI проходит без ошибок
- [ ] Развернуть Swagger UI `public/swagger.html`, публиковать `public/openapi_v1.yaml`
  - Критерии: доступна страница на Hosting; спецификация загружается

### 13. Тестирование
- [ ] Юнит‑тесты `core/*` (валидация, ошибки, idempotency, rate‑limit)
  - Критерии: покрытие ≥ 80%; критические пути покрыты
- [ ] Интеграционные тесты с Firebase Emulator Suite
  - Критерии: сценарии онбординга, объятий, пар, превью паттернов зелёные
- [ ] Контрактные тесты эндпоинтов (`supertest`) по OpenAPI
  - Критерии: снэпшоты ответов стабильны; регрессия ловится CI

### 14. CI/CD
- [ ] Pipeline: `lint → test → emulator e2e → deploy` по веткам/тегам
  - Критерии: защищённые ветки; staging‑деплой по `main`, prod — по релизным тегам
- [ ] Канареечные релизы функций и откат
  - Критерии: возможность быстро откатиться; документация процесса
- [ ] Статический анализ безопасности кода (SAST) — CodeQL/Snyk
  - Критерии: отчёты SAST в CI; блокировка релиза при критических уязвимостях

### 15. OTA и устройства
- [ ] Публикация прошивки в Storage и метаданных в Firestore
  - Критерии: ответ `/ota/firmware/latest` корректен; контроль checksum
- [ ] Отчёты об установке и алерты на фейлы
  - Критерии: алерт при росте ошибок; дашборд успехов OTA

### 16. Телеметрия и аналитика
- [ ] Приём батча событий, схема типов, анти‑PII
  - Критерии: события валидны; PII не сохраняется; агрегаты строятся

### 17. Безопасность и соответствие
- [ ] Реализация подписи вебхуков (HMAC SHA‑256) и ротация секретов
  - Критерии: двусторонняя проверка в период ротации; защита от повтора
- [ ] Политики Privacy (удаление/экспорт аккаунта)
  - Критерии: асинхронная очистка данных; журнал аудита

### 18. Резервное копирование и DR
- [ ] Экспорт Firestore/Storage по расписанию в GCS
  - Критерии: задания планировщика активны; тест восстановления
- [ ] План DR (соседний регион): документ и тренировка
  - Критерии: чёткие инструкции; тайм‑бокс восстановления приемлем

### 19. SLO/SLA
- [ ] Настроить цели: доступность 99.9%, p95 ≤ 500 мс
  - Критерии: алерты по нарушению; ежемесячные отчёты

### 20. Релизы и депрекации
- [ ] Процесс версионирования `/v2` и `Deprecation/Sunset` заголовки
  - Критерии: RFC в `doc/`; пример миграции реализован

---

## Вехи (Milestones)
- M0: Дизайн и Архитектура (документы в `doc/`, OpenAPI, правила, индексы)
- M1: Базовая инфраструктура и охранный периметр (разделы 1–5)
- M2: Критичный функционал (пользователи, устройства, объятия) (раздел 6 частично)
- M3: Контент, паттерны, сессии/статистика (раздел 6 полностью)
- M4: Наблюдаемость, флаги, уведомления, OTA (разделы 8–11)
- M5: Тесты и CI/CD, релиз staging (разделы 12–14)
- M6: Телеметрия, безопасность, резервирование, SLO (разделы 16–19)
- M7: Prod релиз и процесс депрекаций (раздел 20)
- M8: Пострелизный мониторинг и стабилизация (первая неделя: алерты/логи, фидбек, hotfix)

## Критерии готовности к релизу (Go/No‑Go)
- Все чек‑пункты M1–M5 отмечены ✓, SLO метрики зелёные
- Интеграционные e2e тесты зелёные, покрытие ≥ 80%
- Алерты настроены, план отката и runbook готовы


