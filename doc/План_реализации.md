## План реализации Amulet Backend (Firebase)

Документ — пошаговый чек‑лист по запуску и сопровождению бэкенда. Для каждого шага указаны критерии завершённости (DoD). Отмечайте выполнение галочками.

### 0. Организация и репозиторий
- [x] Создать репозиторий и структуру директорий (`functions/`, `public/`, `doc/`)
  - Критерии: репозиторий в VCS; шаблон `.gitignore`; базовая структура создана
- [x] Настроить Node.js LTS и пакетный менеджер (pnpm/npm)
  - Критерии: `node -v` зафиксирован; lockfile присутствует; скрипты `lint`, `test`, `build` в `functions/package.json`
- [x] Принять соглашения код‑стайла и линтеров (ESLint/Prettier/TSConfig)
  - Критерии: конфиги в корне; `pnpm lint`/`pnpm format` проходят без ошибок
- [x] Настроить управление зависимостями (Dependabot/Renovate)
  - Критерии: PR‑бот создаёт обновления; CI прогоняется на PR; авто‑мердж патчей безопасности включён

### 1. Firebase проекты и среды
- [x] Использовать единый существующий проект Firebase (уже инициализирован)
  - Критерии: задокументирован `projectId`; роли доступа назначены ответственным
- [x] Включить сервисы: Auth, Firestore, Storage, App Check, Cloud Functions, Cloud Messaging, Hosting, Remote Config
  - Критерии: все сервисы активны; квоты проверены

### 2. Аутентификация
- [x] Настроить провайдеры Auth (Email/Password, Apple, Google)
  - Критерии: включены провайдеры; настроены OAuth redirect URLs
- [x] Реализовать middleware проверки ID Token в `functions/core/auth.ts`
  - Критерии: e2e тест на защищённую ручку возвращает 401/403 при нарушениях

### 3. База данных (Firestore)
- [x] Создать коллекции: `users`, `devices`, `pairs`, `hugs`, `practices`, `patterns`, `rules`, `sessions`, `telemetry`, `firmware`
  - Критерии: описаны модели в `functions/types/*`
- [x] Применить индексы из `doc/firestore.indexes.json.template`
  - Критерии: импорт индексов выполнен; статусы — `READY`
- [x] Написать миграции сидов контента (минимальный набор практик/паттернов)
  - Критерии: скрипт сидов запускается локально/CI; данные созданы

### 4. Хранилище (Storage)
- [x] Настроить пути: `avatars/{userId}/...`, `audio/practices/{practiceId}/...`, `firmware/{hardwareVersion}/{semver}/...`
  - Критерии: директории/права проверены правилами
- [x] Загрузить тестовые файлы (1 аватар, 1 аудио, 1 прошивка‑заглушка)
  - Критерии: публичное чтение каталога/прошивки работает; приватность аватаров соблюдена

### 5. Security Rules
- [x] Применить Firestore Rules из `doc/firestore.rules.template`
  - Критерии: положительные/негативные тесты через Emulator Suite (own vs foreign docs)
- [x] Применить Storage Rules из `doc/storage.rules.template`
  - Критерии: загрузка аватара владельцем разрешена; другие операции корректно запрещены

### 6. HTTP API (/v1)
- Общее требование: для каждого подпункта обязательны тесты (юнит для логики и валидаций, интеграционные с Firebase Emulator Suite, контрактные по OpenAPI/supertest). PR без тестов не принимается.

- [x] Базовая инфраструктура HTTP
  - [x] Собрать Express‑роутер и общие middleware в `core/http.ts` (логирование, correlation‑id, ETag/кеширование, rate‑limit, idempotency)
  - [x] Подключить App Check и проверку ID Token из `core/auth.ts`
  - [x] Единый формат ошибок и маппинг кодов (`invalid_argument`, `permission_denied`, и т. д.)
  - Критерии: все middleware активны; отрицательные/позитивные интеграционные тесты зелёные

- [x] Пользователи (`/users.me*`)
  - [x] `POST /users.me.init`
  - [x] `GET /users.me`
  - [x] `PATCH /users.me`
  - [x] `POST /users.me/delete`
  - [x] Валидация входа по схемам OpenAPI; проверка владения документами `users`
  - Критерии: сценарий онбординга проходит; удаление — 202 + поставлена асинхронная задача

- [x] Устройства (`/devices*`)
  - [x] `POST /devices.claim` (привязка по `serial+claimToken`)
  - [x] `GET /devices`
  - [x] `GET /devices/:id`
  - [x] `PATCH /devices/:id`
  - [x] `POST /devices/:id/unclaim`
  - [x] Проверка `ownerId == request.auth.uid` в Rules и на сервере; сценарий передачи: `unclaim` → `claim`
  - Критерии: привязка работает; защита владения активна; передача протестирована

- [x] «Объятия» (`/hugs*`)
  - [x] `POST /hugs.send` (идемпотентность, доставка FCM)
  - [x] `GET /hugs` (фильтры, пагинация)
  - [x] `GET /hugs/:id`
  - Критерии: пуш приходит получателю; история корректно фильтруется и пагинируется

- [x] Пары (`/pairs*`)
  - [x] `POST /pairs.invite` (TTL инвайта)
  - [x] `POST /pairs.accept`
  - [x] `GET /pairs`
  - [x] `POST /pairs/:id/block`
  - Критерии: блокировка предотвращает «объятия»; жизненный цикл инвайта покрыт тестами

- [x] Контент и паттерны (`/practices`, `/patterns*`)
  - [x] `GET /practices`, `GET /practices/:id`
  - [x] `POST /patterns`, `GET /patterns`, `GET /patterns.mine`, `GET /patterns/:id`, `PATCH /patterns/:id`, `DELETE /patterns/:id`
  - [x] `POST /patterns/:id/share`, `POST /patterns/preview`
  - [x] Фильтры `hardwareVersion/kind/tags`; валидация `spec` и даун‑левел для разных HW версий
  - Критерии: корректные фильтры и превью; права доступа соблюдены

- [x] Фоновые обработчики
  - [x] Обработчик удаления пользователя (`background/deleteUser`)
  - [x] Transactional Outbox Worker (`background/outboxWorker`): обработка `pattern.shared` с ретраями
  - Критерии: запись в `outbox` создаётся транзакционно из `/patterns/:id/share`; воркер помечает `delivered` и логирует `lastError` при сбоях; интеграционные/юнит‑тесты с моками FCM зелёные

- [x] Сессии и статистика (`/practices*`, `/stats*`)
  - [x] `POST /practices/:id/start`
  - [x] `POST /practices.session/:id/stop`
  - [x] `GET /stats/overview`
  - [x] Расчёт агрегатов и корректная длительность; учёт прерываний
  - Критерии: создание/закрытие сессий корректные; overview совпадает с ожиданиями

- [x] Правила и вебхуки (`/rules*`, `/webhooks/*`)
  - [x] `GET/POST/PATCH/DELETE /rules`
  - [x] `POST /webhooks/:integrationKey` (подпись `X-Signature`, защита от повтора)
  - Критерии: подпись и анти‑replay работают; сценарии включения/выключения правил покрыты

- [x] Уведомления (`/notifications.tokens`)
  - [x] `POST /notifications.tokens`, `DELETE /notifications.tokens`
  - [x] Сохранение/удаление FCM токенов; dedup; защита от спама
  - Критерии: токены корректно регистрируются и отвязываются; отправка FCM работает

- [x] OTA и отчёты (`/ota/firmware/latest`, `/devices/:id/firmware/report`)
  - [x] Определение доступной версии по `hardware/currentFirmware`
  - [x] Приём отчётов установки и агрегация статусов
  - Критерии: выдаётся корректная версия; отчёты агрегируются

- [ ] Телеметрия (`/telemetry/events`)
  - [ ] Приём батча событий; схема и анти‑PII проверки
  - [ ] Фоновые агрегации метрик по расписанию/триггерам
  - Критерии: события валидируются; агрегаты формируются

### 7. Идемпотентность и лимитирование
- [x] Реализация `Idempotency-Key` в `core/idempotency.ts`
  - Критерии: повторный POST возвращает идентичный ответ из кэша в течение TTL
- [x] Реализация rate‑limit в `core/rateLimit.ts`
  - Критерии: при превышении 429 + `Retry-After`; конфиги через Remote Config

### 8. Уведомления (FCM)
- [x] Карта событий: `hug.received`, `pair.invite`, `practice.reminder`, `ota.available`
  - Критерии: шаблоны пушей и локализация готовы; доставляется на тестовые устройства

### 9. Админка и роли
- [x] Custom claims (`admin`, `moderator`) и утилиты назначения
  - Критерии: ручки `/v1/admin/*` требуют `admin` и проходят
- [x] Админ‑ручки: модерация контента/паттернов, публикация прошивок, поиск устройств
  - Критерии: сценарии модерации от начала до публикации работают; протестирован отзыв/бан устройства через админку

### 10. Мониторинг, логи, алерты
- [x] Структурированное логирование (requestId, userId, route, latency)
  - Критерии: логи в Cloud Logging с фильтрами/дашбордами
- [x] Трейсинг Cloud Trace + метрики Cloud Monitoring
  - Критерии: дашборды p50/p95, ошибки 4xx/5xx, алерты по SLO

### 11. Remote Config и флаги
- [x] Ввести ключи: `api.deprecation.v1`, `hugs.cooldown.ms`, `preview.enabled` и пр.
  - Критерии: переключение фич без релиза; аудит изменений включён

### 12. Документация (OpenAPI + Swagger UI)
- [x] Обновить `doc/openapi_v1.yaml` с ошибками 401/403/404/429 (выполнено)
  - Критерии: валидатор OpenAPI проходит без ошибок
- [x] Развернуть Swagger UI `public/swagger.html`, публиковать `public/openapi_v1.yaml`
  - Критерии: доступна страница на Hosting; спецификация загружается

### 13. Тестирование
- [ ] Юнит‑тесты `core/*` (валидация, ошибки, idempotency, rate‑limit)
  - Критерии: покрытие ≥ 80%; критические пути покрыты
- [ ] Интеграционные тесты с Firebase Emulator Suite
  - Критерии: сценарии онбординга, объятий, пар, превью паттернов зелёные
- [ ] Контрактные тесты эндпоинтов (`supertest`) по OpenAPI
  - Критерии: снэпшоты ответов стабильны; регрессия ловится CI

### 14. CI/CD
- [ ] Pipeline: `lint → test → emulator e2e → deploy` по веткам/тегам
  - Критерии: защищённые ветки; staging‑деплой по `main`, prod — по релизным тегам
- [ ] Канареечные релизы функций и откат
  - Критерии: возможность быстро откатиться; документация процесса
- [ ] Статический анализ безопасности кода (SAST) — CodeQL/Snyk
  - Критерии: отчёты SAST в CI; блокировка релиза при критических уязвимостях

### 15. OTA и устройства
- [ ] Публикация прошивки в Storage и метаданных в Firestore
  - Критерии: ответ `/ota/firmware/latest` корректен; контроль checksum
- [ ] Отчёты об установке и алерты на фейлы
  - Критерии: алерт при росте ошибок; дашборд успехов OTA

### 16. Телеметрия и аналитика
- [ ] Приём батча событий, схема типов, анти‑PII
  - Критерии: события валидны; PII не сохраняется; агрегаты строятся

### 17. Безопасность и соответствие
- [ ] Реализация подписи вебхуков (HMAC SHA‑256) и ротация секретов
  - Критерии: двусторонняя проверка в период ротации; защита от повтора
- [ ] Политики Privacy (удаление/экспорт аккаунта)
  - Критерии: асинхронная очистка данных; журнал аудита

### 18. Резервное копирование и DR
- [ ] Экспорт Firestore/Storage по расписанию в GCS
  - Критерии: задания планировщика активны; тест восстановления
- [ ] План DR (соседний регион): документ и тренировка
  - Критерии: чёткие инструкции; тайм‑бокс восстановления приемлем

### 19. SLO/SLA
- [ ] Настроить цели: доступность 99.9%, p95 ≤ 500 мс
  - Критерии: алерты по нарушению; ежемесячные отчёты

### 20. Релизы и депрекации
- [ ] Процесс версионирования `/v2` и `Deprecation/Sunset` заголовки
  - Критерии: RFC в `doc/`; пример миграции реализован

---

## Вехи (Milestones)
- M0: Дизайн и Архитектура (документы в `doc/`, OpenAPI, правила, индексы)
- M1: Базовая инфраструктура и охранный периметр (разделы 1–5)
- M2: Критичный функционал (пользователи, устройства, объятия) (раздел 6 частично)
- M3: Контент, паттерны, сессии/статистика (раздел 6 полностью)
- M4: Наблюдаемость, флаги, уведомления, OTA (разделы 8–11)
- M5: Тесты и CI/CD, релиз staging (разделы 12–14)
- M6: Телеметрия, безопасность, резервирование, SLO (разделы 16–19)
- M7: Prod релиз и процесс депрекаций (раздел 20)
- M8: Пострелизный мониторинг и стабилизация (первая неделя: алерты/логи, фидбек, hotfix)

## Критерии готовности к релизу (Go/No‑Go)
- Все чек‑пункты M1–M5 отмечены ✓, SLO метрики зелёные
- Интеграционные e2e тесты зелёные, покрытие ≥ 80%
- Алерты настроены, план отката и runbook готовы


