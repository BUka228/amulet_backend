# Мониторинг и логирование Amulet Backend

Документ описывает настройку и использование системы мониторинга, логирования и алертов для бэкенда Amulet.

## Обзор

Система мониторинга включает:
- **Структурированное логирование** с Cloud Logging
- **Трейсинг** с Cloud Trace
- **Метрики** с Cloud Monitoring
- **Алерты** по SLO и критическим событиям
- **Дашборды** для визуализации

## Структурированное логирование

### Основные поля

Все логи содержат обязательные поля:
- `requestId` - идентификатор запроса для трейсинга
- `userId` - идентификатор пользователя (если доступен)
- `route` - маршрут API (например, "POST /v1/users.me")
- `latency` - время выполнения в миллисекундах
- `operation` - тип операции (api_call, background_job, business_operation)
- `resource` - затронутый ресурс
- `severity` - уровень важности (debug, info, warn, error)
- `timestamp` - время события в ISO формате

### Использование

```typescript
import { log } from '../core/structuredLogger';

// Базовое логирование
log.info('User profile updated', {
  userId: 'user123',
  operation: 'user_update',
  resource: 'user_profile',
});

// Логирование ошибок
log.error('Database connection failed', {
  operation: 'database_connect',
  error: error.message,
  stack: error.stack,
});

// Бизнес-операции
log.business('user_registration', 'user_profile', 'New user registered', {
  userId: 'user123',
  language: 'en-US',
});

// Производительность
log.performance('database_query', 150, {
  collection: 'users',
  operation: 'get',
});
```

### Фильтры логов

В Cloud Console > Logging можно использовать следующие фильтры:

```sql
-- Ошибки API
severity>=ERROR AND resource.type="cloud_function" AND jsonPayload.operation="api_call"

-- Бизнес-операции
resource.type="cloud_function" AND jsonPayload.operation="business_operation"

-- Фоновые задачи
resource.type="cloud_function" AND jsonPayload.operation="background_job"

-- События безопасности
resource.type="cloud_function" AND jsonPayload.operation="security"

-- Запросы конкретного пользователя
resource.type="cloud_function" AND jsonPayload.userId="user123"
```

## Трейсинг

### Автоматический трейсинг

Все HTTP запросы автоматически создают трейсы с информацией:
- HTTP метод и путь
- Время выполнения
- Статус код ответа
- Размер ответа
- User Agent

### Ручное создание спанов

```typescript
import { trace } from '../core/tracing';

// Асинхронная операция
await trace.execute({
  name: 'database_query',
  kind: trace.span.SpanKind.CLIENT,
  attributes: {
    'db.operation': 'get',
    'db.collection': 'users',
  },
}, async (span) => {
  const result = await db.collection('users').doc(id).get();
  span.setAttributes({
    'db.document_count': 1,
  });
  return result;
});

// Синхронная операция
const result = trace.executeSync({
  name: 'validation',
  attributes: {
    'validation.type': 'user_profile',
  },
}, (span) => {
  return validateUserProfile(data);
});
```

### Специализированные спаны

```typescript
// База данных
const dbSpan = trace.database('get', 'users');

// Внешние API
const apiSpan = trace.external('fcm', 'send');

// Фоновые задачи
const bgSpan = trace.background('user_cleanup');
```

## Метрики

### Автоматические метрики

- `http_requests_total` - количество HTTP запросов
- `http_request_duration` - время выполнения запросов
- `errors_total` - количество ошибок

### Бизнес-метрики

```typescript
import { metrics } from '../core/monitoring';

// Пользователи
metrics.business('users_created', 1, { language: 'en-US' });
metrics.business('users_active', 150, { period: 'daily' });

// Устройства
metrics.device('battery_low', deviceId, 1, { level: '20%' });
metrics.device('connection_lost', deviceId, 1);

// Уведомления
metrics.notification('ios', true); // успешная доставка
metrics.notification('android', false); // неудачная доставка

// OTA обновления
metrics.ota(deviceId, '1.0.0', '1.1.0', true);
```

### Кастомные метрики

```typescript
// Латентность операций
metrics.latency('database_query', 150, { collection: 'users' });

// Использование ресурсов
metrics.resource('firestore', 'read', 25);
metrics.resource('fcm', 'send', 10);

// Пользовательские действия
metrics.userAction('hug_sent', userId, { emotion: 'warm' });
metrics.userAction('practice_completed', userId, { duration: 300 });
```

## SLO и алерты

### Настроенные SLO

1. **Доступность API**: 99.9%
2. **Латентность P95**: 500ms
3. **Процент ошибок**: <1%

### Алерты

- Высокий процент ошибок (>5% 4xx, >1% 5xx)
- Высокая латентность (P95 > 500ms)
- Проблемы с доставкой FCM (<95% успешных)
- Проблемы с OTA обновлениями (<90% успешных)

### Настройка алертов

```bash
# Установка зависимостей
npm install

# Настройка мониторинга
npm run setup:monitoring
```

## Дашборды

### API Overview
- HTTP запросы по статусам
- Латентность (P50, P95, P99)
- Ошибки по типам

### Business Metrics
- Активные пользователи
- Подключенные устройства
- Отправленные "объятия"
- Завершенные практики

### Notifications
- Доставка FCM по платформам
- Латентность отправки
- Ошибки доставки

### Devices & OTA
- Статус подключения устройств
- Уровень заряда батареи
- Успешность OTA обновлений

## Настройка уведомлений

### Email уведомления

1. Перейдите в Cloud Console > Monitoring > Alerting
2. Создайте notification channel для email
3. Назначьте канал алерт политикам

### Slack интеграция

1. Создайте Slack App с webhook
2. Добавьте webhook URL в notification channels
3. Настройте фильтры для разных типов алертов

### PagerDuty

1. Интегрируйте PagerDuty с Google Cloud
2. Настройте escalation policies
3. Создайте service для критических алертов

## Мониторинг в продакшене

### Ключевые метрики для отслеживания

1. **Доступность**: >99.9%
2. **Латентность P95**: <500ms
3. **Ошибки 5xx**: <1%
4. **FCM доставка**: >95%
5. **OTA успешность**: >90%

### Еженедельные отчеты

- Обзор производительности
- Анализ ошибок
- Тренды использования
- Рекомендации по оптимизации

### Инцидент-менеджмент

1. **Критические алерты** (PagerDuty)
2. **Предупреждения** (Slack)
3. **Информационные** (Email)

## Troubleshooting

### Частые проблемы

1. **Высокая латентность**
   - Проверить Firestore индексы
   - Анализировать медленные запросы
   - Оптимизировать код

2. **Ошибки FCM**
   - Проверить токены устройств
   - Обновить сертификаты
   - Анализировать логи доставки

3. **Проблемы с OTA**
   - Проверить доступность Storage
   - Валидировать прошивки
   - Мониторить отчеты устройств

### Полезные запросы

```sql
-- Медленные запросы
jsonPayload.latency > 1000 AND resource.type="cloud_function"

-- Ошибки конкретного пользователя
jsonPayload.userId="user123" AND severity>=ERROR

-- Проблемы с FCM
jsonPayload.operation="fcm_send" AND severity>=WARNING

-- OTA обновления
jsonPayload.operation="ota_update" AND jsonPayload.success=false
```

## Безопасность

### Логирование PII

- Никогда не логируем пароли или токены
- Маскируем чувствительные данные
- Используем audit logs для критических операций

### Аудит

- Все изменения токенов уведомлений
- Админские операции
- Критические бизнес-операции

### Соответствие

- GDPR: право на удаление данных
- CCPA: прозрачность обработки
- SOC 2: аудит и мониторинг




