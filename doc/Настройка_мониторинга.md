# Настройка мониторинга Amulet Backend

Пошаговая инструкция по настройке системы мониторинга, логирования и алертов.

## Предварительные требования

1. Firebase проект с включенными сервисами:
   - Cloud Functions
   - Cloud Logging
   - Cloud Monitoring
   - Cloud Trace

2. Установленные зависимости:
   ```bash
   cd functions
   npm install
   ```

3. Настроенная аутентификация:
   ```bash
   gcloud auth login
   gcloud config set project YOUR_PROJECT_ID
   ```

## Шаг 1: Установка зависимостей

```bash
cd functions
npm install
```

## Шаг 2: Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
GOOGLE_CLOUD_PROJECT=your-project-id
FUNCTION_REGION=us-central1
NODE_ENV=production
```

## Шаг 3: Сборка проекта

```bash
npm run build
```

## Шаг 4: Настройка мониторинга

### Создание алерт политик и SLO

```bash
npm run setup:monitoring
```

Этот скрипт создаст:
- SLO алерты для доступности, латентности и ошибок
- Алерт политики для критических событий
- Базовые метрики

### Создание дашбордов

```bash
npm run create:dashboards
```

Этот скрипт создаст дашборды:
- API Overview
- Business Metrics  
- Notifications
- Devices & OTA

## Шаг 5: Настройка уведомлений

### Email уведомления

1. Перейдите в [Cloud Console > Monitoring > Alerting](https://console.cloud.google.com/monitoring/alerting)
2. Нажмите "Create Notification Channel"
3. Выберите "Email"
4. Введите email адреса для уведомлений
5. Сохраните канал

### Slack интеграция

1. Создайте Slack App:
   - Перейдите в [api.slack.com/apps](https://api.slack.com/apps)
   - Нажмите "Create New App"
   - Выберите "From scratch"
   - Введите название и workspace

2. Настройте Incoming Webhooks:
   - В настройках приложения перейдите в "Incoming Webhooks"
   - Включите "Activate Incoming Webhooks"
   - Нажмите "Add New Webhook to Workspace"
   - Выберите канал для уведомлений
   - Скопируйте Webhook URL

3. Создайте notification channel:
   - В Cloud Console > Monitoring > Alerting
   - Нажмите "Create Notification Channel"
   - Выберите "Slack"
   - Вставьте Webhook URL
   - Сохраните канал

### PagerDuty интеграция

1. Создайте PagerDuty service:
   - Войдите в PagerDuty
   - Создайте новый service
   - Выберите "Google Cloud Platform" как integration type
   - Скопируйте Integration Key

2. Создайте notification channel:
   - В Cloud Console > Monitoring > Alerting
   - Нажмите "Create Notification Channel"
   - Выберите "PagerDuty"
   - Вставьте Integration Key
   - Сохраните канал

## Шаг 6: Настройка алертов

### Назначение каналов уведомлений

1. Перейдите в [Cloud Console > Monitoring > Alerting](https://console.cloud.google.com/monitoring/alerting)
2. Найдите созданные алерт политики
3. Для каждой политики:
   - Нажмите "Edit"
   - В разделе "Notifications" добавьте нужные каналы
   - Настройте документацию алерта
   - Сохраните изменения

### Настройка escalation

Для критических алертов:
1. Создайте escalation policy в PagerDuty
2. Настройте разные уровни уведомлений:
   - Level 1: Slack (немедленно)
   - Level 2: Email (через 5 минут)
   - Level 3: PagerDuty (через 15 минут)

## Шаг 7: Тестирование

### Тест алертов

1. Создайте тестовую ошибку:
   ```bash
   # Вызовите API с неверными данными
   curl -X POST https://your-region-your-project.cloudfunctions.net/api/v1/users.me.init \
     -H "Content-Type: application/json" \
     -d '{"invalid": "data"}'
   ```

2. Проверьте, что алерт сработал в течение 5 минут

### Тест дашбордов

1. Перейдите в [Cloud Console > Monitoring > Dashboards](https://console.cloud.google.com/monitoring/dashboards)
2. Убедитесь, что все дашборды созданы
3. Проверьте, что метрики отображаются корректно

### Тест логирования

1. Перейдите в [Cloud Console > Logging](https://console.cloud.google.com/logs)
2. Используйте фильтры из документации
3. Убедитесь, что логи структурированы правильно

## Шаг 8: Настройка автоматизации

### CI/CD интеграция

Добавьте в ваш CI/CD pipeline:

```yaml
# .github/workflows/monitoring.yml
name: Setup Monitoring
on:
  push:
    branches: [main]
    paths: ['functions/src/core/monitoring.ts', 'functions/src/core/sloConfig.ts']

jobs:
  setup-monitoring:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '22'
      - run: |
          cd functions
          npm install
          npm run setup:monitoring
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
```

### Автоматическое обновление дашбордов

```yaml
# .github/workflows/dashboards.yml
name: Update Dashboards
on:
  schedule:
    - cron: '0 0 * * 0'  # Еженедельно

jobs:
  update-dashboards:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '22'
      - run: |
          cd functions
          npm install
          npm run create:dashboards
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
```

## Шаг 9: Мониторинг в продакшене

### Еженедельные проверки

1. **Доступность**: >99.9%
2. **Латентность P95**: <500ms
3. **Ошибки 5xx**: <1%
4. **FCM доставка**: >95%
5. **OTA успешность**: >90%

### Ежемесячные отчеты

Создайте автоматический отчет:

```bash
# Скрипт для ежемесячного отчета
#!/bin/bash
echo "Monthly Monitoring Report - $(date)"
echo "=================================="
echo "API Availability: $(gcloud monitoring metrics list --filter='metric.type="custom.googleapis.com/amulet/http_requests_total"' --format='value(metric.type)')"
echo "Average Latency: $(gcloud monitoring metrics list --filter='metric.type="custom.googleapis.com/amulet/http_request_duration"' --format='value(metric.type)')"
echo "Error Rate: $(gcloud monitoring metrics list --filter='metric.type="custom.googleapis.com/amulet/errors_total"' --format='value(metric.type)')"
```

## Troubleshooting

### Частые проблемы

1. **Алерты не срабатывают**
   - Проверьте notification channels
   - Убедитесь, что метрики создаются
   - Проверьте пороги алертов

2. **Дашборды пустые**
   - Убедитесь, что метрики отправляются
   - Проверьте временной диапазон
   - Обновите дашборды

3. **Логи не структурированы**
   - Проверьте, что используется новый logger
   - Убедитесь, что middleware подключен
   - Проверьте формат логов

### Полезные команды

```bash
# Проверка метрик
gcloud monitoring metrics list --filter='metric.type:"custom.googleapis.com/amulet"'

# Проверка алертов
gcloud alpha monitoring policies list

# Проверка дашбордов
gcloud alpha monitoring dashboards list

# Просмотр логов
gcloud logging read 'resource.type="cloud_function"' --limit=50
```

## Дополнительные ресурсы

- [Cloud Monitoring Documentation](https://cloud.google.com/monitoring/docs)
- [Cloud Logging Documentation](https://cloud.google.com/logging/docs)
- [Cloud Trace Documentation](https://cloud.google.com/trace/docs)
- [OpenTelemetry Documentation](https://opentelemetry.io/docs/)




